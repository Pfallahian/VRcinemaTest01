<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curated VR Cinema - Quest 3</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
    </style>
</head>
<body>

    <!-- A-Frame Scene -->
    <a-scene renderer="antialias: true; colorManagement: true; foveationLevel: 3; webxr: referenceSpaceType: local-floor" 
             background="color: #000"
             loading-screen="dotsColor: cyan; backgroundColor: black">

        <!-- ASSET MANAGEMENT -->
        <a-assets>
            <a-mixin id="text-header" text="font: exo2bold; align: center; width: 2; color: #00FFFF"></a-mixin>
            
            <video id="cinema-video" src="https://cdn.bitmovin.com/content/assets/playhouse-vr/progressive.mp4" preload="auto" loop="false" crossorigin="anonymous" playsinline webkit-playsinline></video>
            
            <canvas id="star-canvas" width="1024" height="1024"></canvas>
            <canvas id="earth-canvas" width="1024" height="512"></canvas>
            <canvas id="host-ui-canvas" width="1024" height="256"></canvas>
        </a-assets>

        <!-- STATE MANAGER SYSTEM -->
        <a-entity id="app-manager" app-logic></a-entity>

        <!-- ENVIRONMENT & LIGHTING -->
        <a-entity id="ambient-light" light="type: ambient; color: #001133; intensity: 0.3"></a-entity>
        <a-entity id="point-light" light="type: point; color: #00FFFF; intensity: 0.5; distance: 10" position="0 3 0"></a-entity>
        
        <a-sky src="#star-canvas" radius="500"></a-sky>

        <!-- The Earth -->
        <a-sphere id="earth-view" position="0 0 -50" radius="20" src="#earth-canvas" 
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 120000; easing: linear">
             <a-entity light="type: directional; color: #fff; intensity: 1" position="10 10 10"></a-entity>
        </a-sphere>

        <!-- Lobby Floor -->
        <a-circle id="lobby-floor" rotation="-90 0 0" radius="6" position="0 0 0"
                  material="color: #050505; metalness: 0.9; roughness: 0.1; opacity: 0.9; transparent: true"></a-circle>

        <!-- Chairs -->
        <a-entity id="chairs-container">
            <!-- Chair 1 (User/Host) -->
            <a-entity position="0 0 0">
                <a-cylinder height="0.1" radius="0.4" color="#333" metalness="0.8"></a-cylinder>
                <a-box position="0 0.5 0.3" height="1" width="0.6" depth="0.1" color="#222" rotation="-10 0 0"></a-box>
            </a-entity>
            <!-- Chair 2 (Guest) -->
            <a-entity position="-1.5 0 0.5" rotation="0 -30 0">
                <a-cylinder height="0.1" radius="0.4" color="#333" metalness="0.8"></a-cylinder>
                <a-box position="0 0.5 0.3" height="1" width="0.6" depth="0.1" color="#222" rotation="-10 0 0"></a-box>
                <a-entity id="avatar-2" position="0 1.4 0" visible="false">
                    <a-sphere radius="0.15" color="#555"></a-sphere>
                    <a-box position="0 -0.25 0" width="0.4" height="0.3" depth="0.2" color="#444"></a-box>
                    <a-text value="Guest 1" position="0 0.3 0" align="center" width="2"></a-text>
                </a-entity>
            </a-entity>
            <!-- Chair 3 (Guest) -->
            <a-entity position="1.5 0 0.5" rotation="0 30 0">
                <a-cylinder height="0.1" radius="0.4" color="#333" metalness="0.8"></a-cylinder>
                <a-box position="0 0.5 0.3" height="1" width="0.6" depth="0.1" color="#222" rotation="-10 0 0"></a-box>
                 <a-entity id="avatar-3" position="0 1.4 0" visible="false">
                    <a-sphere radius="0.15" color="#555"></a-sphere>
                    <a-box position="0 -0.25 0" width="0.4" height="0.3" depth="0.2" color="#444"></a-box>
                </a-entity>
            </a-entity>
        </a-entity>

        <!-- CINEMA SCREEN -->
        <a-videosphere id="cinema-screen" src="#cinema-video" radius="40" rotation="0 180 0" 
                       visible="false" material="side: back; transparent: true; opacity: 0"></a-videosphere>
        
        <!-- Buffering Spinner -->
        <a-ring id="buffering-icon" visible="false" position="0 1.6 -3" radius-inner="0.1" radius-outer="0.12" color="cyan" theta-length="280"
                animation="property: rotation; to: 0 0 -360; loop: true; dur: 1000; easing: linear"></a-ring>

        <!-- Subtitle Group -->
        <a-entity id="subtitle-group" position="0 1.5 -5" visible="false">
            <a-plane color="black" opacity="0.7" width="6.2" height="1"></a-plane>
            <a-text id="subtitle-text" value="[Subtitles Enabled]\n(Simulated Dialogue)" 
                    align="center" width="6" color="yellow" font="roboto" position="0 0 0.01"></a-text>
        </a-entity>

        <!-- UI ARCHITECTURE -->
        <a-entity id="ui-rig" position="0 1.2 -1.5" rotation="0 0 0">
            
            <!-- State A: Welcome -->
            <a-entity id="ui-welcome">
                <a-plane width="2" height="1" color="#000" material="opacity: 0.8; transparent: true" 
                         border="color: cyan; width: 0.01">
                    <a-text value="CURATED VR CINEMA" position="0 0.3 0.01" mixin="text-header"></a-text>
                    <a-text value="Experience High-Fidelity Social VR" position="0 0.15 0.01" width="1.5" align="center" color="#aaa"></a-text>
                    
                    <a-entity position="0 -0.2 0.02" class="clickable"
                              gaze-button="action: goToDashboard"
                              geometry="primitive: box; width: 0.6; height: 0.15; depth: 0.01"
                              material="color: #005566"
                              animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                              animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200">
                        <a-text value="ENTER LOBBY" z-offset="0.03" align="center" width="1.5"></a-text>
                        <a-ring radius-inner="0.08" radius-outer="0.09" color="cyan" theta-length="0" rotation="0 0 90"
                                animation__load="property: theta-length; to: 360; startEvents: mouseenter; dur: 1500; easing: linear"
                                animation__reset="property: theta-length; to: 0; startEvents: mouseleave; dur: 100">
                        </a-ring>
                    </a-entity>
                </a-plane>
            </a-entity>

            <!-- State B: Dashboard -->
            <a-entity id="ui-dashboard" visible="false" scale="0 0 0">
                <a-plane width="2.5" height="1.5" color="#050505" material="opacity: 0.9; transparent: true; metalness: 0.5">
                    <a-text value="SELECT CONTENT" position="0 0.6 0.01" mixin="text-header" scale="0.8 0.8 0.8"></a-text>
                    
                    <a-entity id="film-grid" position="-0.6 0.1 0.02">
                        <a-entity class="clickable" gaze-button="action: downloadFilm; id: 1"
                                  geometry="primitive: circle; radius: 0.25" 
                                  material="visible: false">
                            <a-circle radius="0.25" color="#333" material="src: #earth-canvas"></a-circle>
                            <a-text value="Big Buck Bunny" position="0 -0.35 0" align="center" width="1.5"></a-text>
                            <a-ring id="ring-1" radius-inner="0.25" radius-outer="0.26" color="gray" theta-length="360"></a-ring>
                        </a-entity>
                    </a-entity>
                    
                    <a-entity position="0.6 0.1 0.02">
                         <a-circle radius="0.25" color="#111" opacity="0.5"></a-circle>
                         <a-text value="Coming Soon" position="0 0 0" align="center" color="#555"></a-text>
                    </a-entity>

                    <a-entity id="action-panel" position="0 -0.4 0.02" visible="false">
                        <a-text id="status-text" value="Ready to Watch" position="0 0.15 0" align="center" width="1.5" color="#0f0"></a-text>
                        <a-entity position="-0.4 0 0" class="clickable" 
                                  gaze-button="action: watchSolo"
                                  geometry="primitive: box; width: 0.5; height: 0.12; depth: 0.01"
                                  material="color: #008800">
                            <a-text value="WATCH SOLO" z-offset="0.02" align="center" width="1.3"></a-text>
                        </a-entity>
                    </a-entity>
                </a-plane>
                
                <a-entity position="0 -0.9 0">
                    <a-plane width="2" height="0.25" color="#111" material="opacity: 0.9">
                        <a-entity position="-0.5 0 0.01" class="clickable" 
                                  gaze-button="action: createParty"
                                  geometry="primitive: plane; width: 0.4; height: 0.15"
                                  material="color: #222">
                            <a-text value="CREATE PARTY" align="center" width="1.2" z-offset="0.01"></a-text>
                        </a-entity>
                        <a-entity position="0.5 0 0.01" class="clickable" 
                                  gaze-button="action: showNumpad"
                                  geometry="primitive: plane; width: 0.4; height: 0.15"
                                  material="color: #222">
                            <a-text value="JOIN PARTY" align="center" width="1.2" z-offset="0.01"></a-text>
                        </a-entity>
                    </a-plane>
                </a-entity>
            </a-entity>

            <!-- Host Controls: NAVIGATION BAR -->
            <!-- Positioned in space as a navigation bar -->
            <a-entity id="host-controls" position="0 0 -2" rotation="-20 0 0" visible="false" scale="2 2 2">
                
                <!-- Background Pill: Uses procedural canvas texture -->
                <a-plane width="1.5" height="0.4" material="src: #host-ui-canvas; transparent: true; opacity: 1; shader: flat"></a-plane>

                <!-- 1. PLAY BUTTON (Green) -->
                <a-entity position="-0.45 0 0.02">
                    <!-- Ring Glow -->
                    <a-ring radius-inner="0.11" radius-outer="0.12" color="#00FF00" material="shader: flat; opacity: 0.8"></a-ring>
                    <!-- Button Base -->
                    <a-circle radius="0.1" color="#003300" material="opacity: 0.9"></a-circle>
                    <!-- Hit Target -->
                    <a-entity class="clickable" gaze-button="action: playParty"
                              geometry="primitive: circle; radius: 0.12"
                              material="visible: false" position="0 0 0.01"></a-entity>
                    <!-- Icon (Triangle) -->
                    <a-entity geometry="primitive: cone; radiusBottom: 0.05; radiusTop: 0; height: 0.01; segmentsRadial: 3" 
                              material="color: #00FF00; shader: flat" rotation="90 -90 0" position="0.01 0 0.01"></a-entity>
                    <!-- Label -->
                    <a-text value="PLAY" color="#00FF00" align="center" position="0 -0.15 0" width="1.5" font="roboto"></a-text>
                </a-entity>

                <!-- 2. PAUSE BUTTON (Yellow) -->
                <a-entity position="0 0 0.02">
                    <!-- Ring Glow -->
                    <a-ring radius-inner="0.11" radius-outer="0.12" color="#FFFF00" material="shader: flat; opacity: 0.8"></a-ring>
                    <!-- Button Base -->
                    <a-circle radius="0.1" color="#333300" material="opacity: 0.9"></a-circle>
                    <!-- Hit Target -->
                    <a-entity class="clickable" gaze-button="action: pauseParty"
                              geometry="primitive: circle; radius: 0.12"
                              material="visible: false" position="0 0 0.01"></a-entity>
                    <!-- Icon (Pause Bars) -->
                    <a-plane width="0.025" height="0.07" color="#FFFF00" position="-0.02 0 0.01" shader="flat"></a-plane>
                    <a-plane width="0.025" height="0.07" color="#FFFF00" position="0.02 0 0.01" shader="flat"></a-plane>
                    <!-- Label -->
                    <a-text value="PAUSE" color="#FFFF00" align="center" position="0 -0.15 0" width="1.5" font="roboto"></a-text>
                </a-entity>

                <!-- 3. END BUTTON (Red) -->
                <a-entity position="0.45 0 0.02">
                    <!-- Ring Glow -->
                    <a-ring radius-inner="0.11" radius-outer="0.12" color="#FF0000" material="shader: flat; opacity: 0.8"></a-ring>
                    <!-- Button Base -->
                    <a-circle radius="0.1" color="#330000" material="opacity: 0.9"></a-circle>
                    <!-- Hit Target -->
                    <a-entity class="clickable" gaze-button="action: endParty"
                              geometry="primitive: circle; radius: 0.12"
                              material="visible: false" position="0 0 0.01"></a-entity>
                    <!-- Icon (Square) -->
                    <a-plane width="0.06" height="0.06" color="#FF0000" position="0 0 0.01" shader="flat"></a-plane>
                    <!-- Label -->
                    <a-text value="END" color="#FF0000" align="center" position="0 -0.15 0" width="1.5" font="roboto"></a-text>
                </a-entity>

            </a-entity>

            <!-- Numpad -->
            <a-entity id="numpad" position="0 0 0.1" visible="false" scale="0 0 0">
                <a-plane width="1.2" height="1.5" color="#111" material="opacity: 0.95" border="color: cyan">
                    <a-text value="ENTER ROOM CODE" position="0 0.6 0.01" align="center" width="2"></a-text>
                    <a-text id="code-display" value="_ _ _" position="0 0.4 0.01" align="center" width="4" color="cyan"></a-text>
                    
                    <a-entity id="keys" position="-0.3 0.1 0.01"></a-entity>

                    <a-entity position="0 -0.5 0.01" class="clickable" gaze-button="action: submitCode">
                        <a-box width="0.4" height="0.1" depth="0.01" color="#005566"></a-box>
                        <a-text value="JOIN" z-offset="0.02" align="center"></a-text>
                    </a-entity>
                     <a-entity position="0 -0.65 0.01" class="clickable" gaze-button="action: closeNumpad">
                        <a-text value="Cancel" align="center" width="1.5" color="#aaa"></a-text>
                    </a-entity>
                </a-plane>
            </a-entity>

        </a-entity>

        <!-- PLAYER RIG -->
        <a-entity id="rig" position="0 0 0">
            <a-camera id="camera" look-controls="pointerLockEnabled: true" wasd-controls="enabled: false" position="0 1.6 0">
                <!-- SAFETY MONITOR -->
                <a-sphere id="boundary-fade" radius="0.5" material="color: black; opacity: 0; side: back; transparent: true" visible="false">
                    <a-text id="boundary-text" value="RETURN TO CENTER" align="center" position="0 0 -0.4" color="red" width="2" visible="false"></a-text>
                </a-sphere>
                <!-- Reticle -->
                <a-entity cursor="fuse: true; fuseTimeout: 1500; objects: .clickable"
                          position="0 0 -1"
                          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                          material="color: cyan; shader: flat"
                          animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.1 0.1 0.1; to: 1 1 1"
                          animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.1 0.1 0.1"
                          animation__reset="property: scale; startEvents: mouseleave; easing: easeInCubic; dur: 500; to: 1 1 1"
                          raycaster="objects: .clickable">
                </a-entity>
            </a-camera>

            <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 5"></a-entity>
            <a-entity laser-controls="hand: left" raycaster="objects: .clickable; far: 5"></a-entity>

            <!-- FLOOR MENU BUTTON -->
            <a-entity id="floor-menu-btn" position="0 0.1 -0.7" rotation="-90 0 0" visible="false" scale="0 0 0">
                <a-circle radius="0.2" color="#111" material="opacity: 0.8; transparent: true; side: double"></a-circle>
                <a-ring radius-inner="0.2" radius-outer="0.22" color="cyan"></a-ring>
                <a-text value="MENU" align="center" rotation="0 0 0" scale="1.5 1.5 1.5" color="cyan"></a-text>
                <a-entity class="clickable" gaze-button="action: openMenu"
                          geometry="primitive: cylinder; radius: 0.22; height: 0.1"
                          material="opacity: 0; transparent: true">
                </a-entity>
            </a-entity>

            <!-- IN-GAME MENU -->
            <a-entity id="ingame-menu" position="0 1.5 -1" visible="false" scale="0 0 0">
                <a-plane width="1.5" height="1.2" color="#050505" material="opacity: 0.95; transparent: true">
                    
                    <a-text value="MENU" position="0 0.45 0.01" align="center" color="cyan" width="3"></a-text>

                    <a-entity position="0.65 0.5 0.02" class="clickable" gaze-button="action: closeMenu">
                        <a-text value="X" color="red" width="3" align="center"></a-text>
                        <a-plane width="0.2" height="0.2" material="opacity: 0; transparent: true"></a-plane>
                    </a-entity>
                    
                    <a-entity position="0 0.15 0.02" class="clickable" 
                              gaze-button="action: backToLobby"
                              geometry="primitive: box; width: 0.8; height: 0.15; depth: 0.01" 
                              material="color: #550000">
                         <a-text value="BACK TO LOBBY" z-offset="0.02" align="center" width="1.5"></a-text>
                    </a-entity>

                    <a-entity position="0 -0.05 0.02" class="clickable" 
                              gaze-button="action: toggleSubtitles"
                              geometry="primitive: box; width: 0.8; height: 0.15; depth: 0.01" 
                              material="color: #333"
                              id="ingame-sub-bg">
                         <a-text id="ingame-sub-label" value="SUBTITLES: OFF" z-offset="0.02" align="center" width="1.5"></a-text>
                    </a-entity>

                    <a-entity position="0 -0.25 0.02" class="clickable" 
                              gaze-button="action: exitApp"
                              geometry="primitive: box; width: 0.8; height: 0.15; depth: 0.01" 
                              material="color: #000; border-color: red">
                         <a-text value="EXIT" z-offset="0.02" align="center" width="1.5" color="#aaa"></a-text>
                    </a-entity>
                </a-plane>
            </a-entity>
        </a-entity>

    </a-scene>

    <script>
        // 1. Procedural Textures Generation
        window.onload = function() {
            const starCanvas = document.getElementById('star-canvas');
            const starCtx = starCanvas.getContext('2d');
            starCtx.fillStyle = 'black';
            starCtx.fillRect(0, 0, 1024, 1024);
            for(let i=0; i<500; i++) {
                const x = Math.random() * 1024;
                const y = Math.random() * 1024;
                const size = Math.random() * 2;
                starCtx.fillStyle = `rgba(255, 255, 255, ${Math.random()})`;
                starCtx.fillRect(x, y, size, size);
            }

            const earthCanvas = document.getElementById('earth-canvas');
            const earthCtx = earthCanvas.getContext('2d');
            earthCtx.fillStyle = '#001133';
            earthCtx.fillRect(0, 0, 1024, 512);
            earthCtx.fillStyle = '#004422';
            for(let i=0; i<20; i++) {
                const x = Math.random() * 1024;
                const y = Math.random() * 512;
                const r = 20 + Math.random() * 80;
                earthCtx.beginPath();
                earthCtx.arc(x, y, r, 0, 2 * Math.PI);
                earthCtx.fill();
            }
            earthCtx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            for(let i=0; i<40; i++) {
                const x = Math.random() * 1024;
                const y = Math.random() * 512;
                const w = 50 + Math.random() * 100;
                const h = 20 + Math.random() * 40;
                earthCtx.fillRect(x, y, w, h);
            }

            // Host UI Canvas Generation (Metallic Pill with Gradient)
            const uiCanvas = document.getElementById('host-ui-canvas');
            const uiCtx = uiCanvas.getContext('2d');
            const w = 1024;
            const h = 256;
            
            // Create Gradient Background
            const grd = uiCtx.createLinearGradient(0, 0, w, h);
            grd.addColorStop(0, "#003366"); // Deep Blue
            grd.addColorStop(0.5, "#001133"); // Dark Center
            grd.addColorStop(1, "#330066"); // Deep Purple

            // Clear
            uiCtx.clearRect(0,0,w,h);
            
            // Draw Rounded Rectangle (Pill)
            const r = h/2; 
            uiCtx.beginPath();
            uiCtx.moveTo(r, 0);
            uiCtx.lineTo(w-r, 0);
            uiCtx.quadraticCurveTo(w, 0, w, r);
            uiCtx.quadraticCurveTo(w, h, w-r, h);
            uiCtx.lineTo(r, h);
            uiCtx.quadraticCurveTo(0, h, 0, r);
            uiCtx.quadraticCurveTo(0, 0, r, 0);
            uiCtx.closePath();
            
            // Fill
            uiCtx.fillStyle = grd;
            uiCtx.fill();
            
            // Glowing Border
            uiCtx.lineWidth = 15;
            uiCtx.strokeStyle = "rgba(0, 255, 255, 0.5)"; // Cyan glow
            uiCtx.stroke();
            
            // Highlight Streak (Top)
            const hl = uiCtx.createLinearGradient(0, 0, w, 0);
            hl.addColorStop(0, "rgba(255,255,255,0)");
            hl.addColorStop(0.5, "rgba(255,255,255,0.2)");
            hl.addColorStop(1, "rgba(255,255,255,0)");
            uiCtx.fillStyle = hl;
            uiCtx.fillRect(0, 10, w, 40);
        };

        // 2. Interaction Component
        AFRAME.registerComponent('gaze-button', {
            schema: {
                action: {type: 'string'},
                id: {type: 'string', default: ''}
            },
            init: function () {
                const el = this.el;
                const data = this.data;
                el.addEventListener('click', () => {
                    const app = document.querySelector('#app-manager').components['app-logic'];
                    if(app) app.handleAction(data.action, data.id);
                });
            }
        });

        // 3. Core Application Logic
        AFRAME.registerComponent('app-logic', {
            init: function() {
                this.state = 'WELCOME'; 
                this.filmStatus = { 1: 'idle' }; 
                this.ui = {
                    welcome: document.querySelector('#ui-welcome'),
                    dashboard: document.querySelector('#ui-dashboard'),
                    hostControls: document.querySelector('#host-controls'),
                    numpad: document.querySelector('#numpad'),
                    grid: document.querySelector('#film-grid'),
                    actionPanel: document.querySelector('#action-panel'),
                    statusText: document.querySelector('#status-text'),
                    ingameMenu: document.querySelector('#ingame-menu'),
                    subtitleGroup: document.querySelector('#subtitle-group'),
                    bufferingIcon: document.querySelector('#buffering-icon'),
                    floorMenu: document.querySelector('#floor-menu-btn') // Added reference
                };
                this.environment = {
                    screen: document.querySelector('#cinema-screen'),
                    video: document.querySelector('#cinema-video'),
                    earth: document.querySelector('#earth-view'),
                    lobbyFloor: document.querySelector('#lobby-floor'),
                    chairs: document.querySelector('#chairs-container'),
                    ambientLight: document.querySelector('#ambient-light'),
                    pointLight: document.querySelector('#point-light')
                };
                this.roomCode = "";
                this.subsOn = false;
                this.manualPause = false; // Track manual pause state
                this.generateNumpad();

                // Bind video events for buffering UI
                this.environment.video.addEventListener('waiting', () => {
                    if(this.state === 'CINEMA') this.ui.bufferingIcon.setAttribute('visible', true);
                });
                this.environment.video.addEventListener('playing', () => {
                    this.ui.bufferingIcon.setAttribute('visible', false);
                });
            },

            generateNumpad: function() {
                const container = document.querySelector('#keys');
                let x = 0, y = 0;
                for(let i=1; i<=9; i++) {
                    const btn = document.createElement('a-entity');
                    btn.setAttribute('position', `${x} ${-y} 0`);
                    btn.setAttribute('class', 'clickable');
                    btn.setAttribute('gaze-button', `action: typeCode; id: ${i}`);
                    btn.setAttribute('geometry', 'primitive: plane; width: 0.2; height: 0.2');
                    btn.setAttribute('material', 'color: #333');
                    btn.innerHTML = `<a-text value="${i}" align="center" z-offset="0.01"></a-text>`;
                    container.appendChild(btn);
                    x += 0.25;
                    if(i % 3 === 0) { x = 0; y += 0.25; }
                }
                const btn0 = document.createElement('a-entity');
                btn0.setAttribute('position', `0.25 ${-y} 0`);
                btn0.setAttribute('class', 'clickable');
                btn0.setAttribute('gaze-button', `action: typeCode; id: 0`);
                btn0.setAttribute('geometry', 'primitive: plane; width: 0.2; height: 0.2');
                btn0.setAttribute('material', 'color: #333');
                btn0.innerHTML = `<a-text value="0" align="center" z-offset="0.01"></a-text>`;
                container.appendChild(btn0);
            },

            handleAction: function(action, id) {
                switch(action) {
                    case 'goToDashboard':
                        this.transitionUI('welcome', 'dashboard');
                        break;
                    case 'downloadFilm':
                        this.downloadFilm(id);
                        break;
                    case 'watchSolo':
                        this.startCinemaMode('solo');
                        break;
                    case 'createParty':
                        if(this.filmStatus[1] !== 'ready') {
                             this.ui.statusText.setAttribute('value', "Select Film First!");
                             this.ui.statusText.setAttribute('color', 'red');
                             setTimeout(() => this.ui.statusText.setAttribute('value', ""), 2000);
                             return;
                        }
                        this.createParty();
                        break;
                    case 'showNumpad':
                        this.ui.numpad.setAttribute('visible', true);
                        this.ui.numpad.setAttribute('scale', '1 1 1');
                        break;
                    case 'closeNumpad':
                        this.ui.numpad.setAttribute('visible', false);
                        this.ui.numpad.setAttribute('scale', '0 0 0');
                        this.roomCode = "";
                        document.querySelector('#code-display').setAttribute('value', "_ _ _");
                        break;
                    case 'typeCode':
                        if(this.roomCode.length < 3) {
                            this.roomCode += id;
                            document.querySelector('#code-display').setAttribute('value', this.roomCode);
                        }
                        break;
                    case 'submitCode':
                        this.joinParty();
                        break;
                    case 'playParty':
                        if(this.state === 'CINEMA') {
                            this.environment.video.play();
                            this.manualPause = false;
                        } else {
                            this.startCinemaMode('party');
                        }
                        break;
                    case 'pauseParty':
                         if(this.environment.video && !this.environment.video.paused) {
                             this.environment.video.pause();
                             this.manualPause = true; // Set flag
                         }
                         break;
                    case 'endParty':
                        this.endCinemaMode();
                        break;
                    case 'openMenu':
                        this.ui.ingameMenu.setAttribute('visible', true);
                        this.ui.ingameMenu.setAttribute('scale', '1 1 1');
                        if(this.environment.video && !this.environment.video.paused) {
                             this.environment.video.pause();
                             // Menu opening counts as a manual action, 
                             // but for safety monitor resuming, we handle logic there.
                        }
                        break;
                    case 'closeMenu':
                        this.ui.ingameMenu.setAttribute('visible', false);
                        this.ui.ingameMenu.setAttribute('scale', '0 0 0');
                        break;
                    case 'backToLobby':
                        location.reload();
                        break;
                    case 'exitApp':
                        document.querySelector('a-scene').exitVR();
                        break;
                    case 'toggleSubtitles':
                        this.subsOn = !this.subsOn;
                        const igBg = document.querySelector('#ingame-sub-bg');
                        const igLbl = document.querySelector('#ingame-sub-label');
                        
                        this.ui.subtitleGroup.setAttribute('visible', this.subsOn);

                        if(this.subsOn) {
                            if(igBg) igBg.setAttribute('color', '#004400');
                            if(igLbl) igLbl.setAttribute('value', 'SUBTITLES: ON');
                        } else {
                            if(igBg) igBg.setAttribute('color', '#333');
                            if(igLbl) igLbl.setAttribute('value', 'SUBTITLES: OFF');
                        }
                        break;
                }
            },

            transitionUI: function(from, to) {
                if(this.ui[from]) {
                    this.ui[from].setAttribute('visible', false);
                    this.ui[from].setAttribute('scale', '0 0 0');
                }
                if(this.ui[to]) {
                    this.ui[to].setAttribute('visible', true);
                    this.ui[to].setAttribute('scale', '1 1 1');
                }
            },

            downloadFilm: function(id) {
                if(this.filmStatus[id] === 'ready') return;
                
                this.filmStatus[id] = 'downloading';
                const ring = document.querySelector(`#ring-${id}`);
                
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 2;
                    const theta = (progress / 100) * 360;
                    ring.setAttribute('theta-length', theta);
                    ring.setAttribute('color', 'cyan');
                    
                    if(progress >= 100) {
                        clearInterval(interval);
                        this.filmStatus[id] = 'ready';
                        ring.setAttribute('color', '#00ff00');
                        this.ui.actionPanel.setAttribute('visible', true);
                        this.ui.statusText.setAttribute('value', "Ready to Watch");
                        this.ui.statusText.setAttribute('color', '#0f0');
                    }
                }, 30);
            },

            createParty: function() {
                this.state = 'PARTY_LOBBY';
                this.ui.dashboard.setAttribute('visible', false);
                
                // Reveal Menu Button
                this.ui.floorMenu.setAttribute('visible', true);
                this.ui.floorMenu.setAttribute('scale', '1 1 1');
                
                const roomCodeText = document.createElement('a-text');
                roomCodeText.setAttribute('value', "ROOM: 8 - 2 - 5\nWaiting for guests...");
                roomCodeText.setAttribute('position', '0 2 -2');
                roomCodeText.setAttribute('align', 'center');
                roomCodeText.setAttribute('scale', '2 2 2');
                roomCodeText.setAttribute('color', 'cyan');
                roomCodeText.setAttribute('id', 'room-hud');
                this.el.sceneEl.appendChild(roomCodeText);

                this.ui.hostControls.setAttribute('visible', true);
                
                setTimeout(() => {
                    document.querySelector('#avatar-2').setAttribute('visible', true);
                    roomCodeText.setAttribute('value', "ROOM: 8 - 2 - 5\nGuest 1 Joined!");
                }, 3000);
            },

            joinParty: function() {
                if(this.roomCode === "825") {
                    this.ui.numpad.setAttribute('visible', false);
                    this.ui.dashboard.setAttribute('visible', false);
                    
                    // Reveal Menu Button
                    this.ui.floorMenu.setAttribute('visible', true);
                    this.ui.floorMenu.setAttribute('scale', '1 1 1');
                    
                    const hud = document.createElement('a-text');
                    hud.setAttribute('value', "Joined Party.\nWaiting for Host...");
                    hud.setAttribute('position', '0 1.5 -2');
                    hud.setAttribute('align', 'center');
                    hud.setAttribute('id', 'guest-hud');
                    this.el.sceneEl.appendChild(hud);

                    const rig = document.querySelector('#rig');
                    rig.setAttribute('position', '-1.5 0 0.5');
                    rig.setAttribute('rotation', '0 -30 0');

                } else {
                    document.querySelector('#code-display').setAttribute('value', "ERROR");
                    this.roomCode = "";
                    setTimeout(() => {
                         document.querySelector('#code-display').setAttribute('value', "_ _ _");
                    }, 1000);
                }
            },

            startCinemaMode: function(mode) {
                this.state = 'CINEMA';
                
                // Reveal Menu Button (if not already visible)
                this.ui.floorMenu.setAttribute('visible', true);
                this.ui.floorMenu.setAttribute('scale', '1 1 1');

                // Hide Lobby Elements
                this.environment.earth.setAttribute('visible', false);
                this.environment.lobbyFloor.setAttribute('visible', false);
                this.environment.chairs.setAttribute('visible', false);
                this.ui.dashboard.setAttribute('visible', false);
                this.ui.welcome.setAttribute('visible', false);
                this.ui.hostControls.setAttribute('visible', false);
                
                // REVEAL HOST NAV BAR FOR HOST OR SOLO
                if (mode === 'solo' || mode === 'party') {
                    this.ui.hostControls.setAttribute('visible', true);
                }

                const hud = document.querySelector('#room-hud');
                if(hud) hud.setAttribute('visible', false);
                const guestHud = document.querySelector('#guest-hud');
                if(guestHud) guestHud.setAttribute('visible', false);

                // Show Screen
                this.environment.screen.setAttribute('visible', true);
                this.environment.screen.setAttribute('animation', 'property: material.opacity; to: 1; dur: 2000');
                
                // House Lights Dimming Logic
                this.environment.ambientLight.setAttribute('animation', 'property: light.intensity; to: 0.05; dur: 3000');
                this.environment.pointLight.setAttribute('visible', false);

                // Restore subtitle state
                this.ui.subtitleGroup.setAttribute('visible', this.subsOn);

                this.environment.video.currentTime = 0;
                this.environment.video.play().catch(e => {
                    console.warn("Video Autoplay blocked, waiting for interaction", e);
                });
            },

            endCinemaMode: function() {
                 this.state = 'WELCOME';
                 location.reload();
            }
        });

        // 4. Improved Safety Monitor (With Hysteresis)
        AFRAME.registerComponent('safety-monitor', {
            init: function() {
                this.breach = false;
            },
            tick: function () {
                const appEl = document.querySelector('#app-manager');
                if(!appEl) return;
                
                const app = appEl.components['app-logic'];
                if (!app || app.state !== 'CINEMA') return;

                const camera = this.el.object3D;
                const distance = Math.sqrt(camera.position.x**2 + camera.position.z**2);

                const fadeSphere = document.querySelector('#boundary-fade');
                const warnText = document.querySelector('#boundary-text');
                const menu = document.querySelector('#ingame-menu');

                // Hysteresis: Trigger warning at 0.5m, release warning at 0.35m
                // Prevents flickering when near boundary
                if (distance > 0.5) {
                    this.breach = true;
                } else if (distance < 0.35) {
                    this.breach = false;
                }

                if (this.breach) { 
                    if(fadeSphere) {
                        fadeSphere.setAttribute('visible', true);
                        fadeSphere.setAttribute('material', 'opacity', 1);
                    }
                    if(warnText) warnText.setAttribute('visible', true);
                    
                    const vid = document.querySelector('#cinema-video');
                    if(vid && !vid.paused) vid.pause();

                } else {
                    if(fadeSphere) {
                        fadeSphere.setAttribute('visible', false);
                        fadeSphere.setAttribute('material', 'opacity', 0);
                    }
                    if(warnText) warnText.setAttribute('visible', false);
                      
                    const vid = document.querySelector('#cinema-video');
                    const isMenuVisible = menu && menu.object3D.visible; 
                    
                    // Only resume if manual pause is NOT active
                    if(vid && vid.paused && !isMenuVisible && !app.manualPause) {
                        vid.play();
                    }
                }
            }
        });
        
        document.querySelector('#camera').setAttribute('safety-monitor', '');

    </script>
</body>
</html>